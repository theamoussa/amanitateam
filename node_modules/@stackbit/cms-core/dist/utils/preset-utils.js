"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDocumentObjectFromPreset = exports.getPresetFromDocument = void 0;
const lodash_1 = __importDefault(require("lodash"));
const types_1 = require("@stackbit/types");
function getPresetData(presetId, field, logger) {
    const dataField = (0, types_1.getLocalizedFieldForLocale)(field);
    let data;
    if (dataField?.type === 'json') {
        data = dataField.value;
    }
    else if (dataField?.type === 'string' || dataField?.type === 'text') {
        try {
            data = JSON.parse(dataField.value);
        }
        catch (err) {
            logger?.error(`Can't parse data field for preset ${presetId}`);
        }
    }
    return data;
}
function getPresetThumbnail(presetId, thumbnailField, csiAssetMap, logger) {
    let thumbnail;
    if (thumbnailField?.type === 'image') {
        const imageFields = (0, types_1.getLocalizedFieldForLocale)(thumbnailField)?.fields;
        if (imageFields) {
            const urlField = imageFields.url;
            if (urlField?.localized) {
                const vals = Object.values(urlField.locales);
                if (vals?.length) {
                    thumbnail = vals[0]?.value;
                }
            }
            else {
                thumbnail = urlField.value;
            }
        }
    }
    else if (thumbnailField?.type === 'reference' && thumbnailField.refType === 'asset') {
        const refId = (0, types_1.getLocalizedFieldForLocale)(thumbnailField)?.refId;
        if (refId) {
            const fileField = csiAssetMap[refId]?.fields.file;
            if (fileField?.localized) {
                const vals = Object.values(fileField.locales);
                if (vals?.length) {
                    thumbnail = vals[0]?.url;
                }
            }
            else {
                thumbnail = fileField?.url;
            }
        }
        else {
            logger?.warn(`No thumbnail reference found for preset ${presetId}`);
        }
    }
    return thumbnail;
}
function getPresetFromDocument({ srcType, srcProjectId, csiDocument, csiAssetMap, logger }) {
    const data = csiDocument.fields['data'] ? getPresetData(csiDocument.id, csiDocument.fields['data'], logger) : null;
    if (!data) {
        logger?.warn(`Error finding preset data for preset ${csiDocument.id}`);
        return null;
    }
    const thumbnail = csiDocument.fields['thumbnail'] ? getPresetThumbnail(csiDocument.id, csiDocument.fields['thumbnail'], csiAssetMap, logger) : null;
    return {
        srcType,
        srcProjectId,
        ...data,
        thumbnail
    };
}
exports.getPresetFromDocument = getPresetFromDocument;
function getDocumentObjectFromPreset(preset, model) {
    let presetData = lodash_1.default.omit(preset, 'thumbnail');
    if (model && model.fields) {
        const dataField = model.fields.find((field) => field.name === 'data');
        if (dataField?.type === 'string' || dataField?.type === 'text') {
            presetData = JSON.stringify(presetData, null, 2);
        }
    }
    return {
        label: preset.label,
        data: presetData
    };
}
exports.getDocumentObjectFromPreset = getDocumentObjectFromPreset;
//# sourceMappingURL=preset-utils.js.map