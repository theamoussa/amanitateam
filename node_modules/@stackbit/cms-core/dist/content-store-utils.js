"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCacheDir = exports.getErrorAtLine = exports.contentChangeResultCounts = exports.isContentChangeResultEmpty = exports.isContentChangesEmpty = exports.updateOperationValueFieldWithCrossReference = exports.getCSIDocumentsAndAssetsFromContentSourceDataByIds = exports.groupDocumentsByContentSource = exports.groupModelsByContentSource = exports.getDocumentFieldForLocale = exports.isDocumentFieldOneOfFieldTypes = exports.getUserContextForSrcType = exports.getUserContextForSrcTypeThunk = exports.findContentSourcesDataForTypeOrId = exports.getContentSourceDataByIdOrThrow = exports.getContentSourceDataByTypeAndProjectIdOrThrow = exports.getObjectId = exports.getContentSourceId = exports.getContentSourceIdForContentSource = void 0;
const lodash_1 = __importDefault(require("lodash"));
const path_1 = __importDefault(require("path"));
const utils_1 = require("@stackbit/utils");
const types_1 = require("@stackbit/types");
function getContentSourceIdForContentSource(contentSource) {
    return getContentSourceId(contentSource.getContentSourceType(), contentSource.getProjectId());
}
exports.getContentSourceIdForContentSource = getContentSourceIdForContentSource;
function getContentSourceId(contentSourceType, srcProjectId) {
    return contentSourceType + ':' + srcProjectId;
}
exports.getContentSourceId = getContentSourceId;
function getObjectId(srcType, srcProjectId, srcObjectId) {
    return `${srcType}:${srcProjectId}:${srcObjectId}`;
}
exports.getObjectId = getObjectId;
function getContentSourceDataByTypeAndProjectIdOrThrow(srcType, srcProjectId, contentSourceDataById) {
    const contentSourceId = getContentSourceId(srcType, srcProjectId);
    return getContentSourceDataByIdOrThrow(contentSourceId, contentSourceDataById);
}
exports.getContentSourceDataByTypeAndProjectIdOrThrow = getContentSourceDataByTypeAndProjectIdOrThrow;
function getContentSourceDataByIdOrThrow(contentSourceId, contentSourceDataById) {
    const contentSourceData = contentSourceDataById[contentSourceId];
    if (!contentSourceData) {
        throw new Error(`Content source not found: '${contentSourceId}'.`);
    }
    return contentSourceData;
}
exports.getContentSourceDataByIdOrThrow = getContentSourceDataByIdOrThrow;
function findContentSourcesDataForTypeOrId({ contentSourceDataById, srcType, srcProjectId }) {
    return lodash_1.default.filter(contentSourceDataById, (contentSourceData) => {
        const srcTypeMatch = !srcType || contentSourceData.srcType === srcType;
        const srcProjectIdMatch = !srcProjectId || contentSourceData.srcProjectId === srcProjectId;
        return srcTypeMatch && srcProjectIdMatch;
    });
}
exports.findContentSourcesDataForTypeOrId = findContentSourcesDataForTypeOrId;
function getUserContextForSrcTypeThunk(user) {
    return (srcType) => getUserContextForSrcType(srcType, user);
}
exports.getUserContextForSrcTypeThunk = getUserContextForSrcTypeThunk;
function getUserContextForSrcType(srcType, user) {
    if (!user) {
        return undefined;
    }
    const connection = user?.connections?.find((connection) => connection.type === srcType);
    return {
        email: user.email,
        name: user.name,
        sso: user.sso,
        role: user.role,
        ...connection
    };
}
exports.getUserContextForSrcType = getUserContextForSrcType;
function isDocumentFieldOneOfFieldTypes(documentField, fieldTypes) {
    return fieldTypes.includes(documentField.type);
}
exports.isDocumentFieldOneOfFieldTypes = isDocumentFieldOneOfFieldTypes;
function getDocumentFieldForLocale(docField, locale) {
    if (docField && docField.localized) {
        if (!locale) {
            return null;
        }
        const { localized, locales, ...base } = docField;
        const localizedField = locales?.[locale];
        if (!localizedField) {
            return null;
        }
        return {
            ...base,
            ...localizedField
        };
    }
    else {
        return docField;
    }
}
exports.getDocumentFieldForLocale = getDocumentFieldForLocale;
function groupModelsByContentSource({ models }) {
    const modelMapByContentSource = {};
    for (const model of models) {
        const { srcType, srcProjectId, ...rest } = model;
        lodash_1.default.set(modelMapByContentSource, [srcType, srcProjectId, model.name], rest);
    }
    return modelMapByContentSource;
}
exports.groupModelsByContentSource = groupModelsByContentSource;
function groupDocumentsByContentSource({ documents }) {
    const documentMapByContentSource = {};
    for (const document of documents) {
        const { srcType, srcProjectId, ...rest } = document;
        (0, utils_1.append)(documentMapByContentSource, [srcType, srcProjectId], rest);
    }
    return documentMapByContentSource;
}
exports.groupDocumentsByContentSource = groupDocumentsByContentSource;
function getCSIDocumentsAndAssetsFromContentSourceDataByIds(contentSourceData, objects) {
    const documents = [];
    const assets = [];
    for (const object of objects) {
        if (object.srcObjectId in contentSourceData.csiDocumentMap) {
            documents.push(contentSourceData.csiDocumentMap[object.srcObjectId]);
        }
        else if (object.srcObjectId in contentSourceData.csiAssetMap) {
            assets.push(contentSourceData.csiAssetMap[object.srcObjectId]);
        }
    }
    return {
        documents,
        assets
    };
}
exports.getCSIDocumentsAndAssetsFromContentSourceDataByIds = getCSIDocumentsAndAssetsFromContentSourceDataByIds;
function updateOperationValueFieldWithCrossReference(type, refObject) {
    if ((0, types_1.isOneOfFieldTypes)(type, ['json', 'cross-reference'])) {
        return {
            type,
            value: refObject
        };
    }
    return {
        type,
        value: JSON.stringify(refObject)
    };
}
exports.updateOperationValueFieldWithCrossReference = updateOperationValueFieldWithCrossReference;
function isContentChangesEmpty(contentChanges) {
    return (!contentChanges ||
        (!contentChanges.documents?.length &&
            !contentChanges.assets?.length &&
            !contentChanges.scheduledActions?.length &&
            !contentChanges.deletedDocumentIds?.length &&
            !contentChanges.deletedAssetIds?.length &&
            !contentChanges.deletedScheduledActionIds?.length));
}
exports.isContentChangesEmpty = isContentChangesEmpty;
function isContentChangeResultEmpty(contentChangeResult) {
    return (contentChangeResult.createdDocuments.length === 0 &&
        contentChangeResult.createdAssets.length === 0 &&
        contentChangeResult.createdScheduledActions.length === 0 &&
        contentChangeResult.updatedDocuments.length === 0 &&
        contentChangeResult.updatedAssets.length === 0 &&
        contentChangeResult.updatedScheduledActions.length === 0 &&
        contentChangeResult.deletedDocuments.length === 0 &&
        contentChangeResult.deletedAssets.length === 0 &&
        contentChangeResult.deletedScheduledActions.length === 0);
}
exports.isContentChangeResultEmpty = isContentChangeResultEmpty;
function contentChangeResultCounts(contentChangeResult) {
    return {
        createdDocumentsCount: contentChangeResult.createdDocuments.length,
        createdAssetsCount: contentChangeResult.createdAssets.length,
        createdScheduledActionsCount: contentChangeResult.createdScheduledActions.length,
        updatedDocumentsCount: contentChangeResult.updatedDocuments.length,
        updatedAssetsCount: contentChangeResult.updatedAssets.length,
        updatedScheduledActionsCount: contentChangeResult.updatedScheduledActions.length,
        deletedDocumentsCount: contentChangeResult.deletedDocuments.length,
        deletedAssetsCount: contentChangeResult.deletedAssets.length,
        deletedScheduledActionsCount: contentChangeResult.deletedScheduledActions.length
    };
}
exports.contentChangeResultCounts = contentChangeResultCounts;
// eslint-disable-next-line @typescript-eslint/ban-types
function getErrorAtLine(dropLastCallStackEntries, dropCallStackFunc) {
    const tempErr = new Error();
    Error.captureStackTrace(tempErr, dropCallStackFunc ?? getErrorAtLine);
    const atLine = tempErr.stack?.split('\n')[1 + dropLastCallStackEntries]?.trim();
    return atLine ? ` ${atLine}` : '';
}
exports.getErrorAtLine = getErrorAtLine;
function getCacheDir(stackbitConfig) {
    return stackbitConfig.cacheDir ?? path_1.default.resolve(stackbitConfig.dirPath, '.stackbit/cache');
}
exports.getCacheDir = getCacheDir;
//# sourceMappingURL=content-store-utils.js.map